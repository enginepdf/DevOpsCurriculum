# Quest 13. 마이크로서비스와 람다

## Introduction
* 이번 퀘스트에서는 마이크로서비스의 개념과 람다 서비스에 대해 알아보겠습니다.

## Topics
* 마이크로서비스
* Lambda
* API Gateway

## Resources
* https://news.hada.io/topic?id=638
* https://www.redhat.com/ko/topics/microservices/what-are-microservices
* https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/welcome.html
* https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/welcome.html

## Checklist
* 마이크로서비스가 무엇인가요? 이러한 구조의 장점은 무엇일까요?

        애플리케이션 구축을 위한 아키텍처 기반의 접근 방식
        전통적 monolithic 접근 방식과 구별 짓는 기준은 애플리케이션을 핵심 기능으로 세분화하는 방식
        각 기능을 서비스라고 부르며, 독립적 구축 및 배포 가능(개별 서비스가 다른 서비스에 부정적 영향을 주지 않으면서 작동(또는 장애가 발생)할 수 있음을 의미)
          ex) 검색창, 상품 추천 내역, 온라인 장바구니
        마이크로서비스 아키텍처는 애플리케이션의 핵심 기능을 유연하게 결합하고, 불가피한 장애, 향후 확장 여부 및 새로운 기능 통합에 대비할 수 있도록 서비스 간 커뮤니케이션 및 개발팀의 구조를 조정하는 것
          -> 서비스 지향 아키텍처(Service Oriented Architecture, SOA)의 기본 사항을 채택하여 마이크로서비스를 배포하는 것
             SOA의 경우 애플리케이션을 별개의 재사용 가능한 서비스 단위로 분할하며 이 서비스들은 엔터프라이즈 서비스 버스(Enterprise Service Bus, ESB - 서비스들을 컴포넌트화된 논리적 집합으로 묶는 핵심 미들웨어)를 통해 공유
             SOA의 경우 이러한 서비스 요소가 ESB를 통해 통합되어 하나의 애플리케이션을 구성(ESB는 전체 시스템의 단일 장애점을 나타내어 잠재적인 전체 조직의 자체적 장애 요소로 작용할 수 있음)
        컨테이너화 기술의 발달에 힘입어 유용성 향상

        최소한의 변경 사항에도 자체적인 QA(Quality Assurance) 주기에 따라 대규모 업데이트 할 필요가 없어짐
        서비스의 구축, 테스트, 수정을 동시에 수행할 수 있어 더 이상의 모놀리식 개발 주기는 필요 없게 됨
        stateless 방식으로 서로 통신 할 수 있어 이러한 방식으로 구축된 애플리케이션은 내결함성이 더 높고 단일 ESB에 대한 의존성은 더 낮음
        프로그래밍 언어에 구속 받지 않는 API이기 때문에 개발팀이 자체 툴 선택 가능
        출시 기간 단축(민첩한 배포 및 업데이트) - 분산형 개발을 통해 팀의 역량과 일상적 업무 능력 향상, 동시에 여러 마이크로서비스 개발 가능, 동일 애플리케이션 개발에 더 많은 개발자 동시 참여 가능하여 개발 소요 시간 단축
        높은 화장성 - 특정 서비스에 대한 수요 증가에 따라 필요 시 여러 서버 및 인프라에 배포 가능
        뛰어난 복구 능력 - 모놀리식 애플리케이션 모델과는 달리 한 부분에 장애가 발생해도 전체 애플리케이션이 다운되지 않음
        손쉬운 배포 - 전통적 모놀리식 애플리케이션에 비해 더욱 모듈화 되고 규모가 작아져 배포에 따르는 우려 사항 사라짐(더 많은 협업이 필요하지만, 그 결과는 몇 배로 나타날 수 있음)
        편리한 액세스 - 하나의 큰 애플리케이션을 더 작은 조각으로 분할하여 개발자들이 각 조각을 파악하고 업데이트하며 개선하기가 용이해짐(애자일 방식과 결합할 경우 개발 주기 더욱 가속화 가능)
        향상된 개방성 - 다중 언어 지원(Polyglot) API를 사용하여 개발자들은 필요한 기능에 맞는 최적의 언어와 기술을 자유롭게 선택 가능

        * 애자일 소프트웨어 개발 - less document-oriented, code-oriented. 어느 특정 개발 방법론을 가리키는 말은 아니고 Agile(기민한) 개발을 가능하게 해주는 다양한 방법론 전체를 일컫는 말
                             계획을 통해 주도해 나갔던 과거의 방법론(폭포수 모델 등)과는 다르게 앞을 예측하며 개발을 하지 않고, 일정 주기를 가지고 끊임없이 프로토타입을 만들어내며 그때마다 필요한 요구를 더하고 수정하여 하나의 커다란 소프트웨어를 개발해 나가는 adaptive style이라고 함


* AWS Lambda는 어떤 서비스일까요? 이러한 서비스는 어떤 특징을 가지고, 어디에 쓰일 수 있을까요?

        AWS Lambda는 서버를 프로비저닝하거나 관리하지 않고도 코드를 실행할 수 있게 해주는 컴퓨팅 서비스
        필요 시에만 코드 실행. 리소스(메모리, CPU, 네트워크 등) 자동 확장. 사용한 컴퓨팅 시간만큼만 비용 지불
        제공된 런타임에서 로그인하여 인스턴스를 컴퓨팅하거나 운영 체제를 사용자 지정할 수 없는 제약 조건을 통해 Lambda는 용량 프로비저닝, 플릿 상태 모니터링, 보안 패치 적용, 코드 배포, Lambda 함수 모니터링 및 로깅과 같은 운영 및 관리 작업 수행 가능
        지원 언어 중 하나로 코드를 공급하기만 하면 고가용성 컴퓨팅 인프라에서 코드를 실행하고 서버 및 운영 체제 유지 관리, 용량 프로비저닝 및 자동 조정, 코드 및 보안 패치 배포, 코드 모닡터링 및 로깅 등 모든 컴퓨팅 리소스 관리 수행
        AWS 규모, 성능, 보안에 따라 작동하는 자체 백엔드 생성 가능
        Amazon S3, DynamoDB 테이블의 데이터 변경과 같은 이벤트에 대한 응답으로 코드 실행 가능
        이벤트에 의해 트리거되고 AWS CodePipeline 및 CodeBuild를 사용하여 자동으로 배포하는 함수로 구성된 서버리스 애플리케이션 빌드 가능
        사용자는 자신의 코드에 대해서만 책임을 갖음
        
  * AWS Lambda의 Cold start와 Warm start는 어떤 개념일까요? Lambda의 동시성이란 무엇일까요?

        Cold start : 배포 패키지의 크기와 코드 실행 시간 및 코드의 초기화 시간에 따라 새 실행 환경으로 호출을 라우팅할 때 발생 가능한 지연 시간
                     (Lambda 함수 호출 시 실행 환경으로 라우팅된 후 요청이 처리되는데 한 동안 함수를 사용하지 않았다면 더 많은 동시 호출을 처리하거나 함수 업데이트 시 새 실행 환경이 생성되고
                      실행 환경이 생성되는 동안 함수 코드가 설치되고 실행 시간이 시작)
                     설정 메모리에 따라서도 Cold start time이 다르고 람다가 VPC 네트워크 내부에 속하는지 여부, Cognito나 IAM을 사용하여 인증을 하는지에 여부, 같은 프로그래밍 언어라도 버전에 따라 지연시간 차이난다고 함
                     람다를 5분마다 실행하면 Cold start를 해결할 수 있다고 함(CloudWatch를 통해 람다를 5분마다 한번씩 지속적 호출하거나 Route 53에서 Health Check를 람다 함수 API Gateway Endpoint로 설정 가능 --> Warm 상태 유지에 따른 추가 비용 발생 가능)
                     호출이 많을 때도 람다가 스케일링 될 경우 지연시간 발생 가능

        Warm start : 보통 Warm이라는 것을 사용 준비가 된 상태라는 의미로 쓰이는 것 같음
                     Cold start 후 Warm 상태를 유지하여 람다를 다시 호출해도 지연시간이 발생하지 않고 빠르게 응답
                     5분여 이상 호출이 되지 않는 경우 Cold 상태로 바뀌게 되고 다시 호출 시 지연시간을 가지고 Cold start 하게 됨

        동시성 : 특정 시각에 함수가 제공하는 요청의 수
               함수가 호출되면 Lambda는 함수의 인스턴스를 할당하여 이벤트 처리. 함수 코드가 실행을 마치면 다른 요청을 처리할 수 있음
               요청을 처리하는 동안 함수가 다시 호출되면, 다른 인스턴스가 할당되어 함수의 동시성 증가(동시성에는 리전의 모든 함수가 공유하는 리전 할당량이 적용)

                예약된 동시성 - 해당 함수로만 사용할 수 있는 요청 풀을 생성(해당 함수가 예약되지 않은 동시성을 사용하지 못하게 함)
                             함수가 항상 일정 수준의 동시성에 도달할 수 있도록 보장하려면 예약된 동시성으로 함수 구성(함수의 최대 동시성을 제한. 버전 및 별칭을 포함하여 함수 전체에 적용)
                             Lambda에서 함수의 인스턴스를 할당하면 런타임은 함수의 코드를 로드하고 핸들러 외부에서 정의하는 초기화 코드 실행
                                코드 및 종속성이 크거나 초기화 중에 SDK 클라이언트를 생성하는 경우 이 프로세스에 약간 시간 걸릴 수 있음. 함수가 확장 시 새 인스턴스에서 제공하는 요청 부분이 나머지보다 긴 지연 시간을 갖게 됨

                프로비저닝된 동시성 - 함수의 호출에 응답할 준비가 되도록 요청된 수의 실행 환경을 초기화. 지연 시간의 변동 없이 함수 확장할 수 있도록 함
                                 호출이 증가하기 전에 프로비저닝된 동시성을 할당하면 매우 짧은 지연 시간으로 초기화된 인스턴스에서 모든 요청 처리하도록 할 수 있음
                                 함수의 버전이나 별칭에서 프로비저닝된 동시성 구성 가능
                                 함수를 지속적으로 초기화하고 아주 빠르게 준비하여 두 자리 수 밀리초로 응답하는 기능 
                                    웹 및 모바일 백엔드, 지연 시간에 민감한 마이크로서비스 또는 동기식 API와 같은 대화형 서비스를 구현하기에 적합
                                 Lambda 함수 호출 시 실행 환경으로 라우팅된 후 요청 처리.
                                 한 동안 함수 사용하지 않았다면 더 많은 동시 호출을 처리하거나 함수를 업데이트해야 하는 경우 새 실행 환경이 생성
                                 실행 환경이 생성되는 동안 함수 코드가 설치되고 실행 시간이 시작
                
                * 런타임 : 컴퓨터 과학에서 컴퓨터 프로그램이 실행되고 있는 동안의 동작
                         컴퓨터 언어 안에 쓰인 프로그램을 관리하기 위해 특정한 컴파일러나 가상 머신이 사용하는 기본 코드의 라이브러리나 프로그램을 가리키는 런타임 라이브러리라고도 일컫음

                * 런타임 환경 : 컴퓨터가 실행되는 도안 프로세스나 프로그램을 위한 소프트웨어 서비스를 제공하는 가상 머신의 상태(운영 체제 자체에 속하는 경우도 있고 운영 체제에서 작동하는 소프트웨어를 뜻하기도 함)

  * AWS Lambda의 Layer는 어떤 개념일까요?

        Lambda 함수가 추가 코드와 콘텐츠를 계층의 형태로 가져오도록 구성할 수 있게 함
        계층은 라이브러리, 사용자 지정 런타임 또는 기타 종속 항목을 포함하는 .zip 파일 아카이브 등
        배포 패키지에 라이브러리 포함시킬 필요 없이 계층을 통해 함수에서 라이브러리 사용 가능(배포 패키지를 작게 유지하여 개발 더 수월. 함수 코드 사용하여 종속 항목 설치하고 패키징할 때 발생 가능한 오류 방지)
        외부 프레임워크를 사용하여 함수를 deploy할 때마다 함수에서 필요로 하는 패키지들을 모두 올려야했던 기존 방식에서 함수들이 공통으로 사용할 패키지를 Layer로 구성하여
        deploy 성능도 패키지 부분을 제외한 함수 코드만 하게 되어 가벼워 짐
        자주 사용하는 함수 모듈을 Layer로 만들어 놓으면 개발팀의 개발 생산성 향상 가능

* API Gateway는 어떤 서비스인가요? 어떤 설정을 할 수 있을까요?

        규모와 관계 없이 REST 및 WebSocket API를 생성, 게시, 유지, 모니터링 및 보호하기 위한 AWS 서비스
        API 개발자는 AWS나 다른 웹 서비스는 물론 AWS 클라우드에 저장된 데이터에 액세스하는 API 생성 가능
        자체 클라이언트 애플리케이션에서 사용할 API 생성 가능. 타사 앱 개발자가 API를 사용하도록 제공 가능

                상태 저장(WebSocket, stateful) 및 상태 비저장(HTTP, REST - stateless) API에 대한 지원
                AWS Identity and Access Management(IAM) 정책, Lambda 권한 부여자 함수 및 Amazon Cognito 사용자 풀과 같은 강력하고 유연한 인증 메커니즘 지원
                변경 사항을 안전하게 롤아웃하기 위한 Canary 릴리스 배포
                API 사용 및 API 변경에 대한 CloudTrail 로깅 및 모니터링
                경보 설정 기능을 포함한 CloudWatch 액세스 로깅 및 실행 로깅
                AWS CloudFormation 템플릿을 사용하여 API 생성을 활성화 할 수 있는 기능
                사용자 지정 도메인 이름 지원
                일반적 web exploit으로부터 API 보호 위한 AWS WAF와 통합
                성능 지연 시간 파악 및 학습을 위해 AWS X-Ray와 통합

## Quest

* AWS Lambda와 API Gateway를 이용해 새로운 웹서비스를 하나 구축해 보세요. (기존 컨테이너 기반의 서비스는 그대로 둡니다!)(O)

* 만들어 둔 정적인 웹사이트에서, 기존 컨테이너 기반의 API에 더해 Lambda 기반의 API 역시 활용할 수 있도록 수정해 보세요.(O)

        Cloudfront에서 작동하도록 수정(HTTPS 사용을 위해 기존 컨테이너 기반의 API cors 수정 필요). Lambda, API Gateway 기반 API fetch는 동작

* API Gateway를 통해 서비스 되고 있는 API가 우리만의 도메인을 가지고 HTTPS로 서비스될 수 있도록 하려면 어떻게 해야 할까요?

        Route 53의 Alias 기능을 사용 + AWS Certificate Manager